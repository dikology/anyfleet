# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

default_platform(:ios)

platform :ios do
  desc "Run tests"
  lane :test do
    scan(
      project: "anyfleet/anyfleet.xcodeproj",
      scheme: "anyfleet",
      # Let Fastlane auto-detect available simulators
      # This is more reliable across different environments
      ensure_devices_found: true,
      code_coverage: false,
      clean: true,
      # Use xcbeautify for proper Swift Testing output display
      xcodebuild_formatter: "xcbeautify",
      # Disable parallel testing for CI reliability
      # This prevents random freezes and ensures Swift Testing output is properly displayed
      # The scheme already has parallelizable="NO", but we add these args for extra safety
      xcargs: "-parallel-testing-worker-count 1 -parallel-testing-enabled NO",
      output_directory: "./fastlane/test_output",
      # xcbeautify doesn't support HTML output, only junit
      output_types: "junit",
      buildlog_path: "./fastlane/test_output"
    )
  end

  desc "Set up code signing with match"
  lane :setup_signing do
    # Only set up match if MATCH_GIT_URL is provided
    if ENV["MATCH_GIT_URL"]
      match_type = ENV["EXPORT_METHOD"] == "development" ? "development" : "appstore"
      
      match(
        type: match_type,
        app_identifier: "com.dikology.anyfleet",
        git_url: ENV["MATCH_GIT_URL"],
        git_branch: ENV["MATCH_GIT_BRANCH"] || "main",
        readonly: ENV["CI"] == "true", # In CI, don't try to create new profiles
        force: false,
        force_for_new_devices: false
      )
    else
      UI.important("⚠️  MATCH_GIT_URL not set. Skipping match setup.")
      UI.important("   For CI builds, you should set up match:")
      UI.important("   1. Create a private git repo for certificates")
      UI.important("   2. Run locally: bundle exec fastlane match appstore")
      UI.important("   3. Set MATCH_GIT_URL in your CI secrets")
    end
  end

  desc "Build and archive the app"
  lane :build do
    # Allow export method to be overridden via environment variable
    # Use "development" for local builds, "app-store" for CI/TestFlight
    export_method = ENV["EXPORT_METHOD"] || "app-store"
    
    # Set up code signing if match is configured
    if ENV["MATCH_GIT_URL"]
      setup_signing
    end
    
    build_app(
      project: "anyfleet/anyfleet.xcodeproj",
      scheme: "anyfleet",
      export_method: export_method,
      output_directory: "./fastlane/build_output"
    )
  end

  desc "Build and archive the app (local development - uses development export)"
  lane :build_local do
    ENV["EXPORT_METHOD"] = "development"
    build
  end

  desc "Upload to TestFlight"
  lane :beta do
    # Build and archive
    build
    
    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: false,
      skip_submission: true,
      distribute_external: false,
      notify_external_testers: false
    )
  end

  desc "Run tests and upload to TestFlight if on main branch"
  lane :ci do
    # Always run tests
    test
    
    # Only deploy to TestFlight if on main branch and label is present
    if git_branch == "main" && ENV["DEPLOY_TO_TESTFLIGHT"] == "true"
      beta
    else
      UI.message("Skipping TestFlight deployment. Set DEPLOY_TO_TESTFLIGHT=true to deploy.")
    end
  end
end

